# 魔兽世界空投助手插件 (AirdropHelper) 设计文档

## 项目概述
一个用于监控魔兽世界空投箱子的插件，支持魔兽世界 11.2 版本。该插件能够监控NPC对话、检测空投箱子、发送通知并提供倒计时界面。

## 核心功能需求

### 1. NPC对话监控
- **监听事件**: `CHAT_MSG_MONSTER_SAY`
- **监控目标**: 不同地图的特定NPC
- **触发关键词配置**:
  ```lua
  local npcKeywords = {
      ["魯夫厄斯"] = { "我在這附近", "附近有一箱資源", "機不可失", "附近似乎有寶藏" },
      ["瑪莉希亞"] = { "附近有資源", "準備戰鬥" }
  }
  ```
- **功能**: 当指定NPC说出包含关键词的话时，触发空投警报

### 2. 智能通知系统
- **优先级顺序**:
  1. 团队警报 (如果有团队警报权限)
  2. 团队频道 (如果在团队中)
  3. 小队频道 (如果在小队中)
  4. 普通说话频道 (默认)
- **通知内容格式**: `"空投箱子" + 当前地图名称 + 当前时间（HH:MM）`
- **示例**: "空投箱子 暴风城 14:35"

### 3. 倒计时UI界面
- **窗体规格**:
  - 无边框窗体
  - 宽度: 4个标准图标宽度
  - 高度: 可变，最多显示10个进度条
- **进度条功能**:
  - 每次触发空投创建新的进度条
  - **NPC触发**: 18分钟倒计时
  - **视觉触发**: 16分钟倒计时
  - 颜色变化:
    - 绿色: 初始状态
    - 黄色: 剩余时间 < 8分钟
    - 红色: 剩余时间 < 2分钟
    - 闪烁: 时间归零后开始闪烁，继续负数计时
- **进度条文本**: `地图名：剩余时间` (例: "暴风城：15:32")

### 4. 空投箱子视觉检测
- **检测方式**: 参考HandyNotes插件的空投箱子检测逻辑
- **触发条件**: 
  - 当前地图没有NPC触发的空投信息时
  - 视觉检测到空投箱子
- **计时**: 16分钟倒计时
- **优先级**: NPC触发优先于视觉检测，避免重复计时

### 5. 玩家间信息同步
- **同步机制**: 类似HandyNotes或Silver Dragon的报警功能
- **同步内容**:
  - 空投触发位置
  - 触发时间
  - 剩余时间
- **通信频道**: 公会频道、团队频道或自定义频道

## 技术实现要点

### API兼容性
- 支持魔兽世界 11.2 版本
- 使用最新的WoW API
- 确保向后兼容性

### 事件处理
```lua
-- 主要监听事件
CHAT_MSG_MONSTER_SAY        -- NPC对话
ADDON_LOADED                -- 插件加载
PLAYER_ENTERING_WORLD       -- 进入世界
ZONE_CHANGED_NEW_AREA       -- 区域变更
```

### 数据存储
- 使用SavedVariables保存用户设置
- 临时数据使用内存存储
- 同步数据通过插件通信协议

### UI框架
- 使用原生WoW UI框架
- 响应式设计适应不同分辨率
- 支持拖拽和锁定功能

## 潜在问题和解决方案

### 1. NPC名称本地化问题
**问题**: 不同语言客户端NPC名称不同
**解决方案**: 
- 使用NPC ID而非名称匹配
- 提供多语言关键词支持
- 建立NPC ID到名称的映射表

### 2. 空投箱子检测准确性
**问题**: 如何准确识别空投箱子而非普通容器
**解决方案**:
- 研究HandyNotes的检测逻辑
- 使用物品ID、模型ID等多重验证
- 建立已知空投箱子的特征库

### 3. 性能优化
**问题**: 频繁的事件监听可能影响游戏性能
**解决方案**:
- 实现事件节流机制
- 只在相关地图启用监控
- 优化字符串匹配算法

### 4. 同步冲突
**问题**: 多个玩家同时触发可能造成重复通知
**解决方案**:
- 实现去重机制
- 使用时间戳和位置坐标验证
- 设置同步延迟避免竞争

### 5. UI缩放问题
**问题**: 不同UI缩放下界面显示异常
**解决方案**:
- 使用相对坐标系统
- 动态计算UI元素大小
- 提供手动调整选项

## 开发阶段规划

### 阶段1: 基础框架
- 创建插件基础结构
- 实现配置系统
- 建立事件监听框架

### 阶段2: 核心功能
- NPC对话监控
- 基础通知系统
- 简单UI界面

### 阶段3: 高级功能
- 空投箱子视觉检测
- 完整倒计时UI
- 玩家间同步

### 阶段4: 优化完善
- 性能优化
- 错误处理
- 用户体验改进

## 配置选项
- 启用/禁用插件
- 自定义NPC关键词
- 通知方式选择
- UI位置和大小调整
- 同步频道设置
- 倒计时时长自定义

## 测试计划
- 单人测试各项功能
- 多人测试同步功能
- 不同地图环境测试
- 性能压力测试
- 兼容性测试

---

*注意: 本设计文档可能需要根据实际开发过程中遇到的技术限制和API变化进行调整。*